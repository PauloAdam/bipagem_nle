<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SeparaÃ§Ã£o de Pedido</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  max-width:600px;
  margin:auto;
  padding:20px;
}

h2 {
  text-align:center;
}

input, button {
  width:100%;
  padding:16px;
  font-size:18px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
  box-sizing:border-box;
}

input {
  background:#020617;
  color:#fff;
}

button {
  cursor:pointer;
}

button.primary {
  background:#2563eb;
  color:white;
}

button.success {
  background:#16a34a;
  color:white;
}

.item {
  background:#020617;
  padding:14px;
  border-radius:8px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item.active {
  border:2px solid #38bdf8;
}

.item.done {
  opacity:0.5;
}

.counter {
  font-size:42px;
  text-align:center;
  margin:20px 0;
}

.badge {
  font-size:18px;
}

hr {
  margin:20px 0;
  border:0;
  border-top:1px solid #334155;
}
</style>
</head>

<body>

<h2>SeparaÃ§Ã£o de Pedido</h2>

<input id="pedidoInput" placeholder="NÃºmero do pedido">
<button class="primary" id="btnPedido" onclick="carregarPedido()">
  Carregar Pedido
</button>

<hr>

<input id="scanInput" autofocus placeholder="Bipe o produto">

<div id="lista"></div>
<div id="ativo"></div>

<button class="success" onclick="finalizarPedido()">Finalizar Pedido</button>

<script>
let pedido = {};
let produtoAtivo = null;
let carregandoPedido = false;

/* =========================
   CARREGAR PEDIDO
========================= */
async function carregarPedido() {
  if (carregandoPedido) return;

  const numero = pedidoInput.value.trim();
  if (!numero) return alert("Informe o nÃºmero do pedido");

  carregandoPedido = true;
  btnPedido.disabled = true;
  btnPedido.innerText = "Buscando...";

  try {
    const r = await fetch(`/pedido/${numero}`);
    const data = await r.json();

    if (!r.ok || data.erro) {
      throw data;
    }

    pedido = data;
    produtoAtivo = null;
    render();

  } catch (e) {
    alert(e?.erro || "Erro ao buscar pedido");
  } finally {
    carregandoPedido = false;
    btnPedido.disabled = false;
    btnPedido.innerText = "Carregar Pedido";
  }
}

/* =========================
   SCAN (ATUALIZA ESTADO LOCAL)
========================= */
document.getElementById("scanInput").addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  const codigo = e.target.value.trim();
  if (!codigo) return;

  const r = await fetch("/scan", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ codigo })
  });

  const data = await r.json();

  if (data.erro) {
    alert(data.erro);
    e.target.value = "";
    return;
  }

  // ðŸ”¥ sincroniza o contador local
  pedido[data.idProduto].bipado = data.bipado;

  // define produto ativo ao primeiro scan
  if (!produtoAtivo) {
    produtoAtivo = data.idProduto;
  }

  e.target.value = "";
  render();
});

/* =========================
   FINALIZAR ITEM FALTANDO
========================= */
function finalizarItem(id) {
  const p = pedido[id];

  if (p.bipado >= p.pedido) return;

  if (confirm("Realmente deseja finalizar este item faltando?")) {
    p.bipado = p.pedido;
    produtoAtivo = null;
    render();
  }
}

/* =========================
   FINALIZAR PEDIDO
========================= */
async function finalizarPedido() {

  const faltantes = Object.values(pedido)
    .filter(p => p.bipado < p.pedido)
    .map(p => `${p.nome} (${p.pedido - p.bipado})`);

  if (faltantes.length) {
    if (!confirm(
      "Itens faltantes:\n\n" +
      faltantes.join("\n") +
      "\n\nDeseja continuar?"
    )) return;
  }

  if (!confirm("TEM CERTEZA QUE DESEJA FINALIZAR O PEDIDO?")) return;

  const r = await fetch("/finalizar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ confirmado: true })
  });

  const data = await r.json();

  if (data.ok) {
    alert("SeparaÃ§Ã£o finalizada com sucesso");
    location.reload();
  } else {
    alert(data.erro || "Erro ao finalizar");
  }
}

/* =========================
   RENDER
========================= */
function render() {
  lista.innerHTML = "";
  ativo.innerHTML = "";

  const itens = Object.values(pedido);

  if (!produtoAtivo) {
    itens.forEach(p => {
      const div = document.createElement("div");
      div.className =
        "item " +
        (p.bipado === p.pedido ? "done" : "");

      div.innerHTML = `
        <span>${p.nome}</span>
        <span class="badge">
          ${p.bipado}/${p.pedido}
          ${p.bipado === p.pedido ? "âœ”" : ""}
        </span>
      `;
      lista.appendChild(div);
    });
  } else {
    const p = pedido[produtoAtivo];

    ativo.innerHTML = `
      <div class="item active">
        <strong>${p.nome}</strong>
        <span>${p.bipado}/${p.pedido}</span>
      </div>

      <div class="counter">
        ${p.bipado} / ${p.pedido}
      </div>

      <button class="success" onclick="finalizarItem('${p.idProduto}')">
        âœ” Finalizar item faltando
      </button>
    `;
  }
}
</script>

</body>
</html>
